<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real Estate Price Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    html {
    font-size: 18px;
    }

    @media (max-width: 768px) {
    html {
    font-size: 16px;
    }
    }

    body {
      margin: 0;
      background: url('https://aaferimmobilier.com/wp-content/uploads/2025/02/00c257dd-cd08-4e9b-934e-990d06a10096.jpeg') no-repeat center center fixed;
      background-size: cover;
      color: #000;
    }

    .overlay {
      background: rgba(0, 0, 0, 0.5);
      width: 100%;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding-top: 15px;
  padding-bottom: 0px;
  padding-left: 20px;
  padding-right: 20px;
  background-color: rgba(255, 255, 255, 0);
  border-radius: 10px;
  margin-bottom: 0;
  flex-wrap: wrap;
}


body[lang="ar"] {
  direction: rtl;
  text-align: right;
}

    .selectors select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .logo {
  max-height: 320px;
  width: auto;
  height: auto;
  max-width: 100%;
  display: block;
  margin: 0 auto;
}

    #parkingPriceField {
   transition: all 0.3s ease;
    }


    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      background-color: rgba(255, 255, 255, 0.756);
      padding: 20px;
      border-radius: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .field {
      margin-bottom: 5px;
    }

    .field label {
      display: block;
      margin-bottom: 5px;
    }

    .field input, .field select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .results span {
      font-weight: bold;
      font-size: 16px;
      display: block;
      margin-top: 5px;
    }

    .pdf-button {
      margin-top: 30px;
      text-align: center;
    }

    .pdf-button button {
      background-color: #000;
      color: #fff;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    .error-msg {
      color: red;
      font-size: 12px;
      margin-top: 5px;
    }
    .popup-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  }

.popup-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  }

.popup-content label {
  font-size: 14px;
  display: flex;
  flex-direction: column;
  }

.popup-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  }
  select#hasParking {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  width: 55%;
 }



  </style>
</head>
<body>
  <div class="overlay">
    <div class="header">
      <div class="selectors">
        <select id="languageSelector">
          <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
          <option value="en">ğŸ‡¬ğŸ‡§ English</option>
          <option value="ar">ğŸ‡²ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
          <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
          <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
          <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        </select>
      </div>
      <div class="logo-wrapper">
        <img class="logo" src="https://aaferimmobilier.com/wp-content/uploads/2022/01/logo-def-no-background.png" alt="Logo">
      </div>
            <div class="selectors">
        <select id="currencySelector">
          <option value="MAD">ğŸ‡²ğŸ‡¦ MAD</option>
          <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
          <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
        </select>
      </div>
    </div>

    <div class="container">
      <!-- LEFT COLUMN -->
      <div class="column">
        <div class="field">
          <label for="propertyType">Type de bien</label>
          <select id="propertyType">
            <option value="apartment">Appartement</option>
            <option value="terrace">Appartement avec terrasse</option>
            <option value="commercial">Local commercial</option>
          </select>
        </div>
    
        <div class="field">
          <label for="surface">Surface (mÂ²)</label>
          <input type="number" id="surface" placeholder="e.g. 100">
        </div>
    
        <div class="field" id="extraSurfaceField" style="display:none;">
          <label id="extraLabel">Terrasse/Mezzanine (mÂ²)</label>
          <input type="number" id="extraSurface" placeholder="e.g. 50">
        </div>
    
        <div class="field">
          <label for="priceM2">Prix/(mÂ²)</label>
          <input type="number" id="priceM2" placeholder="e.g. 20000">
        </div>
    
        <div class="field" style="display: flex; align-items: center; justify-content: space-between;">
          <label for="hasParking" id="labelHasParking" style="margin-right: 10px;">Place de parking ?</label>
          <select id="hasParking" style="width: 55%;">
            <option value="no">Non</option>
            <option value="yes">Oui</option>
          </select>
        </div>
        
    
        <div class="field" id="parkingPriceField" style="display: none;">
          <label for="parkingPrice" id="labelParkingPrice">Prix du parking</label>
          <input type="number" id="parkingPrice" placeholder="e.g. 150000">
        </div>
      </div>
    
      <!-- RIGHT COLUMN -->
      <div class="column">
        <div class="field">
          <label for="paymentPercent">% Paiement initial</label>
          <input type="number" id="paymentPercent" placeholder="e.g. 30">
        </div>
    
        <div class="field results">
          <label>Montant Total</label>
          <span id="totalPrice">0</span>
        </div>
    
        <div class="field results">
          <label>Paiement Initial</label>
          <span id="initialPayment">0</span>
        </div>
    
        <div class="field results">
          <label>Reste Ã  Payer</label>
          <span id="remainingAmount">0</span>
        </div>
      </div>
    </div>
    

    <div class="pdf-button">
      <button onclick="openPopup()">ğŸ“„ TÃ©lÃ©charger en PDF</button>

    </div>
    <div id="popupForm" style="display:none;" class="popup-overlay">
      <div class="popup-content">
        <h3>Informations du client</h3>
        <label>Nom du client: <input type="text" id="clientName" /></label>
        <label>TÃ©lÃ©phone: <input type="text" id="clientPhone" /></label>
        <label>Projet: <input type="text" id="projectName" /></label>
        <label>Bloc/Immeuble: <input type="text" id="block" /></label>
        <label>Ã‰tage: <input type="text" id="floor" /></label>
        <label>Type d'appartement: <input type="text" id="apartmentType" /></label>
        <label>Surface: <input type="text" id="refSurface" /></label>
        <div class="popup-buttons">
          <button onclick="generatePDF().catch(e => alert('Erreur PDF: ' + e.message))">Exporter</button>
          <button onclick="closePopup()">Annuler</button>
        </div>
      </div>
    </div>
    
  </div>

  <script>
    window._calculatedValues = {
  total: 0,
  initial: 0,
  remaining: 0
};

    let currentLang = "fr"; // default language
    const propertyType = document.getElementById('propertyType');
    const surfaceInput = document.getElementById('surface');
    const extraSurfaceInput = document.getElementById('extraSurface');
    const priceM2Input = document.getElementById('priceM2');
    const paymentPercentInput = document.getElementById('paymentPercent');
    const totalPriceEl = document.getElementById('totalPrice');
    const initialPaymentEl = document.getElementById('initialPayment');
    const remainingAmountEl = document.getElementById('remainingAmount');
    const extraSurfaceField = document.getElementById('extraSurfaceField');
    const extraLabel = document.getElementById('extraLabel');

    let exchangeRates = { EUR: 0.091, USD: 0.10, MAD: 1 };

    async function fetchExchangeRates() {
      try {
        const res = await fetch('https://api.exchangerate.host/latest?base=MAD');
        const data = await res.json();
        exchangeRates = data.rates || exchangeRates;
        calculate();
      } catch {
        alert("Erreur taux de change. Valeurs par dÃ©faut utilisÃ©es.");
      }
    }
    
    document.getElementById("parkingPrice").addEventListener("input", calculate);
        document.getElementById("hasParking").addEventListener("change", () => {
          const show = document.getElementById("hasParking").value === "yes";
          document.getElementById("parkingPriceField").style.display = show ? "block" : "none";
          calculate(); // recalculate after changing selection
        });

    function calculate() {
      const surface = parseFloat(surfaceInput.value) || 0;
      const extraSurface = parseFloat(extraSurfaceInput.value) || 0;
      const priceM2 = parseFloat(priceM2Input.value) || 0;
      const paymentPercent = parseFloat(paymentPercentInput.value) || 0;
      const hasParking = document.getElementById("hasParking").value === "yes";
      const parkingPrice = hasParking ? parseFloat(document.getElementById("parkingPrice").value) || 0 : 0;

      if (!surface || !priceM2) {
        totalPriceEl.textContent = initialPaymentEl.textContent = remainingAmountEl.textContent = '0';
        return;
      }

      let adjustedSurface = surface;
      if (propertyType.value !== 'apartment') adjustedSurface += extraSurface / 2;




      const total = adjustedSurface * priceM2 + parkingPrice;
      const initial = total * (paymentPercent / 100);
      const remaining = total - initial;

        // Store raw values globally for PDF use
        window._calculatedValues = {
        total,
        initial,
        remaining
        };


      const currency = document.getElementById('currencySelector').value;
      const rate = exchangeRates[currency] || 1;

      totalPriceEl.textContent = formatCurrency(total * rate, currency);
      initialPaymentEl.textContent = formatCurrency(initial * rate, currency);
      remainingAmountEl.textContent = formatCurrency(remaining * rate, currency);
    }

    function formatCurrency(value, currency) {
      return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(value);
    }
    const pdfText = {
  fr: {
    title: "Fiche de consultation immobiliÃ¨re",
    name: "Nom du client",
    phone: "TÃ©lÃ©phone",
    project: "Projet",
    block: "Bloc",
    floor: "Ã‰tage",
    type: "Type",
    refSurface: "Surface (rÃ©f)",
    inputSurface: "Surface saisie",
    extra: "Surface supplÃ©mentaire",
    price: "Prix/(mÂ²)",
    percent: "Paiement initial",
    total: "Montant total",
    upfront: "Paiement initial",
    remaining: "Reste Ã  payer"
  },
  en: {
    title: "Real Estate Consultation Sheet",
    name: "Client Name",
    phone: "Phone Number",
    project: "Project",
    block: "Block",
    floor: "Floor",
    type: "Type",
    refSurface: "Reference Surface",
    inputSurface: "Entered Surface",
    extra: "Extra Surface",
    price: "Price per mÂ²",
    percent: "Upfront Payment",
    total: "Total Amount",
    upfront: "Upfront Payment",
    remaining: "Remaining Amount"
  },
  ar: {
    title: "Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¹Ù‚Ø§Ø±ÙŠØ©",
    name: "Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†",
    phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
    project: "Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
    block: "Ø§Ù„Ø¹Ù…Ø§Ø±Ø©",
    floor: "Ø§Ù„Ø·Ø§Ø¨Ù‚",
    type: "Ø§Ù„Ù†ÙˆØ¹",
    refSurface: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Ø±Ø¬Ø¹ÙŠØ©)",
    inputSurface: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©",
    extra: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©",
    price: "Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹",
    percent: "Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ",
    total: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
    upfront: "Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰",
    remaining: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"
  }
};
function generatePDF_old() {
  console.log("generatePDF triggered");

  const doc = new window.jspdf.jsPDF();


  // Translation dictionary
  

  const langText = pdfText[currentLang] || pdfText.fr;

  // Collect calculated values
  const surface = document.getElementById("surface").value;
  const extraSurface = document.getElementById("extraSurface").value;
  const price = document.getElementById("priceM2").value;
  const percent = document.getElementById("paymentPercent").value;
  const total = document.getElementById("totalPrice").textContent;
  const initial = document.getElementById("initialPayment").textContent;
  const remaining = document.getElementById("remainingAmount").textContent;
  const currency = document.getElementById("currencySelector").value;

  // Collect form input values
  const client = document.getElementById("clientName").value;
  const phone = document.getElementById("clientPhone").value;
  const project = document.getElementById("projectName").value;
  const block = document.getElementById("block").value;
  const floor = document.getElementById("floor").value;
  const type = document.getElementById("apartmentType").value;
  const refSurface = document.getElementById("refSurface").value;

  // Set direction for Arabic (RTL)
  if (currentLang === "ar") {
    doc.setFont("Helvetica", "normal");
    doc.setFontSize(14);
    doc.text(langText.title, 200, 20, { align: "right" });

    doc.setFontSize(12);
    let y = 40;
    doc.text(`${langText.name}: ${client}`, 200, y, { align: "right" });
    doc.text(`${langText.phone}: ${phone}`, 200, y += 10, { align: "right" });
    doc.text(`${langText.project}: ${project}`, 200, y += 10, { align: "right" });
    doc.text(`${langText.block}: ${block}`, 200, y += 10, { align: "right" });
    doc.text(`${langText.floor}: ${floor}`, 200, y += 10, { align: "right" });
    doc.text(`${langText.type}: ${type}`, 200, y += 10, { align: "right" });
    doc.text(`${langText.refSurface}: ${refSurface} Ù…Â²`, 200, y += 10, { align: "right" });

    y += 20;
    doc.text(`${langText.inputSurface}: ${surface} Ù…Â²`, 200, y += 10, { align: "right" });
    if (extraSurface && extraSurface > 0) {
      doc.text(`${langText.extra}: ${extraSurface} Ù…Â²`, 200, y += 10, { align: "right" });
    }
    doc.text(`${langText.price}: ${price} ${currency}`, 200, y += 10, { align: "right" });
    doc.text(`${langText.percent}: ${percent}%`, 200, y += 10, { align: "right" });
    doc.text(`${langText.total}: ${total}`, 200, y += 20, { align: "right" });
    doc.text(`${langText.upfront}: ${initial}`, 200, y += 10, { align: "right" });
    doc.text(`${langText.remaining}: ${remaining}`, 200, y += 10, { align: "right" });

  } else {
    doc.setFontSize(16);
    doc.text(langText.title, 20, 20);

    doc.setFontSize(12);
    doc.text(`${langText.name}: ${client}`, 20, 40);
    doc.text(`${langText.phone}: ${phone}`, 20, 45);
    doc.text(`${langText.project}: ${project}`, 20, 50);
    doc.text(`${langText.block}: ${block}`, 20, 60);
    doc.text(`${langText.floor}: ${floor}`, 20, 70);
    doc.text(`${langText.type}: ${type}`, 20, 80);
    doc.text(`${langText.refSurface}: ${refSurface} mÂ²`, 20, 90);

    doc.text(`${langText.inputSurface}: ${surface} mÂ²`, 20, 110);
    if (extraSurface && extraSurface > 0) {
      doc.text(`${langText.extra}: ${extraSurface} mÂ²`, 20, 120);
    }
    doc.text(`${langText.price}: ${price} ${currency}`, 20, 130);
    doc.text(`${langText.percent}: ${percent}%`, 20, 140);
    doc.text(`${langText.total}: ${total}`, 20, 160);
    doc.text(`${langText.upfront}: ${initial}`, 20, 170);
    doc.text(`${langText.remaining}: ${remaining}`, 20, 180);
  }
  doc.setFontSize(8);
doc.setTextColor(90, 90, 90);
doc.text("GROUPE AAFER IMMOBILIER - ROUTE DE MALABATA, TANGIER OFFSHORE PLAZA, BORJ AL ANDALOUS I", 105, 280, { align: "center" });
doc.text("+212 539 944 323 | +212 660 370 388", 105, 285, { align: "center" });
doc.text("Lun-Ven 09h-17h Â· Sam 09h-13h", 105, 290, { align: "center" });

  doc.save("fiche-client.pdf");
  closePopup();
}


    const translations = {
  en: {
    type: "Property Type",
    surface: "Surface (mÂ²)",
    extra: "Terrace/Mezzanine (mÂ²)",
    price: "Price per mÂ²",
    percent: "Upfront Payment (%)",
    total: "Total Amount",
    upfront: "Upfront Payment",
    remaining: "Remaining Amount",
    download: "ğŸ“„ Download PDF",
    option1: "Apartment",
    option2: "Apartment with terrace",
    option3: "Commercial unit",
    terrace: "Terrace Surface (mÂ²)",
    mezzanine: "Mezzanine Surface (mÂ²)",


  },
  fr: {
    type: "Type de bien",
    surface: "Surface (mÂ²)",
    extra: "Terrasse/Mezzanine (mÂ²)",
    price: "Prix/(mÂ²)",
    percent: "% Paiement initial",
    total: "Montant Total",
    upfront: "Paiement Initial",
    remaining: "Reste Ã  Payer",
    download: "ğŸ“„ TÃ©lÃ©charger en PDF",
    option1: "Appartement",
    option2: "Appartement avec terrasse",
    option3: "Local commercial",
    terrace: "Surface de la terrasse (mÂ²)",
    mezzanine: "Surface de la mezzanine (mÂ²)",


  },
  ar: {
    type: "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±",
    surface: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²)",
    extra: "Ø´Ø±ÙØ© / Ù…ÙŠØ²Ø§Ù†ÙŠÙ† (Ù…Â²)",
    price: "Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ Ù…ØªØ± Ù…Ø±Ø¨Ø¹",
    percent: "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ",
    total: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
    upfront: "Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰",
    remaining: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ",
    download: "ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF",
    option1: "Ø´Ù‚Ø©",
    option2: "Ø´Ù‚Ø© Ù…Ø¹ Ø´Ø±ÙØ©",
    option3: "Ù…Ø­Ù„ ØªØ¬Ø§Ø±ÙŠ",
    terrace: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø´Ø±ÙØ© (Ù…Â²)",
    mezzanine: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠÙ† (Ù…Â²)",


  },
  es: {
    type: "Tipo de propiedad",
    surface: "Superficie (mÂ²)",
    extra: "Terraza/Entrepiso (mÂ²)",
    price: "Precio por mÂ²",
    percent: "Pago inicial (%)",
    total: "Monto total",
    upfront: "Pago inicial",
    remaining: "Monto restante",
    download: "ğŸ“„ Descargar PDF",
    option1: "Apartamento",
    option2: "Apartamento con terraza",
    option3: "Local comercial",
    terrace: "Superficie de la terraza (mÂ²)",
    mezzanine: "Superficie del entrepiso (mÂ²)",


  }
};


function applyTranslations(lang) {
  currentLang = lang; // update the global variable
  const t = translations[lang];
  document.querySelector("label[for='propertyType']").textContent = t.type;
  document.querySelector("label[for='surface']").textContent = t.surface;
  document.getElementById("extraLabel").textContent = t.extra;
  document.querySelector("label[for='priceM2']").textContent = t.price;
  document.querySelector("label[for='paymentPercent']").textContent = t.percent;

  const propertySelect = document.getElementById('propertyType');
  propertySelect.options[0].text = t.option1;
  propertySelect.options[1].text = t.option2;
  propertySelect.options[2].text = t.option3;


  const results = document.querySelectorAll('.results label');
  results[0].textContent = t.total;
  results[1].textContent = t.upfront;
  results[2].textContent = t.remaining;

  document.querySelector(".pdf-button button").textContent = t.download;

  // Update text direction for Arabic
  document.body.setAttribute("lang", lang);
}

    propertyType.addEventListener('change', () => {
      if (propertyType.value === 'terrace') {
  extraSurfaceField.style.display = 'block';
  extraLabel.textContent = translations[currentLang].terrace;
} else if (propertyType.value === 'commercial') {
  extraSurfaceField.style.display = 'block';
  extraLabel.textContent = translations[currentLang].mezzanine;
} else {
  extraSurfaceField.style.display = 'none';
}

      calculate();
    });

    [surfaceInput, extraSurfaceInput, priceM2Input, paymentPercentInput].forEach(input => {
      input.addEventListener('input', calculate);
    });

    document.getElementById('currencySelector').addEventListener('change', calculate);
    document.getElementById('languageSelector').addEventListener('change', (e) => {
   const lang = e.target.value;
   currentLang = lang;
    applyTranslations(lang);
    });

   
   applyTranslations(currentLang); // consistent usage

    // Toggle parking price input
    document.getElementById("hasParking").addEventListener("change", function () {
      const show = this.value === "yes";
      document.getElementById("parkingPriceField").style.display = show ? "block" : "none";
      calculate();
    });


    fetchExchangeRates();

    function openPopup() {
  document.getElementById("popupForm").style.display = "flex";
}

function closePopup() {
  document.getElementById("popupForm").style.display = "none";
}

function formatPlainNumber(val) {
  const number = typeof val === 'string' ? parseFloat(val.replace(/[^\d.]/g, '')) : val;
  const currency = document.getElementById("currencySelector").value;

  if (isNaN(number)) return "0,00 " + currency;

  const parts = number.toFixed(2).split(".");
  const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  const decimalPart = parts[1];

  return `${integerPart},${decimalPart} ${currency}`;
}


// --------- PDF EXPORT FUNCTION WITH TABLES, LOGO, MULTILINGUAL ---------
 async function generatePDF() {
    calculate(); // Ensure calculations are up-to-date
  const { jsPDF } = window.jspdf;
const doc = new jsPDF();

  // REGISTER autoTable PLUGIN HERE
  window.jspdf = window.jspdf || {};
  window.jspdf.jsPDF = jsPDF;

  if (!doc.autoTable) {
  alert("AutoTable plugin is not available.");
  return;
}



  const lang = document.getElementById('languageSelector').value;
  const translations = {
    fr: {
      title: "Fiche de Consultation ImmobiliÃ¨re",
      general: "Informations gÃ©nÃ©rales",
      project: "DÃ©tails du projet",
      property: "DÃ©tails de la propriÃ©tÃ©",
      finance: "SynthÃ¨se financiÃ¨re",
      headers1: ["Projet", "Bloc", "Ã‰tage", "Type"],
      headers2: ["Surface", "Mezzanine", "Prix/mÂ²", "Parking"],
      headers3: ["Montant total", "Paiement initial", "Reste Ã  payer"],
      client: "Nom du client",
      phone: "TÃ©lÃ©phone"
    },
    en: {
      title: "Real Estate Consultation Sheet",
      general: "General Information",
      project: "Project Details",
      property: "Property Details",
      finance: "Financial Summary",
      headers1: ["Project", "Block", "Floor", "Type"],
      headers2: ["Surface", "Mezzanine", "Price/mÂ²", "Parking"],
      headers3: ["Total", "Initial", "Remaining"],
      client: "Client Name",
      phone: "Phone"
    },
    ar: {
      title: "Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©",
      general: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©",
      project: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
      property: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±",
      finance: "Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ",
      headers1: ["Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", "Ø§Ù„ÙƒØªÙ„Ø©", "Ø§Ù„Ø·Ø§Ø¨Ù‚", "Ø§Ù„Ù†ÙˆØ¹"],
      headers2: ["Ø§Ù„Ù…Ø³Ø§Ø­Ø©", "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠÙ†", "Ø³Ø¹Ø±/Ù…Â²", "Ø§Ù„Ù…ÙˆÙ‚Ù"],
      headers3: ["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ø¯ÙØ¹Ø©", "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"],
      client: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„",
      phone: "Ø§Ù„Ù‡Ø§ØªÙ"
    }
  };
  const t = translations[lang];

  const currency = document.getElementById("currencySelector").value;

  // Header
 // Logo temporarily disabled due to CORS issue
doc.setFontSize(16);
doc.setTextColor(130, 96, 50);
doc.text(t.title, 105, 45, { align: "center" });

  doc.setFontSize(16);
  doc.setTextColor(130, 96, 50);
  doc.text(t.title, 105, 45, { align: "center" });

  let y = 55;

  // General Info
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.text(t.general, 15, y); y += 8;

  const client = document.getElementById("clientName").value;
  const phone = document.getElementById("clientPhone").value;
  doc.text(`${t.client}: ${client}`, 15, y); y += 6;
  doc.text(`${t.phone}: ${phone}`, 15, y); y += 10;

  // Project Table
  doc.text(t.project, 15, y); y += 8;
  const headers1 = t.headers1;
  const row1 = [
    document.getElementById("projectName").value,
    document.getElementById("block").value,
    document.getElementById("floor").value,
    document.getElementById("apartmentType").value
  ];
  doc.autoTable({
  startY: y,
  head: [headers1],
  body: [row1],
  theme: 'grid',
  headStyles: {
  fillColor: [208, 171, 128],
  textColor: 0 // 0 = black
}

});

  y = doc.lastAutoTable.finalY + 10;

  // Property Table
  doc.text(t.property, 15, y); y += 8;
  const headers2 = t.headers2;
  const row2 = [
  document.getElementById("surface").value + " mÂ²",
  document.getElementById("extraSurface").value + " mÂ²",
  formatPlainNumber(document.getElementById("priceM2").value),
  formatPlainNumber(document.getElementById("parkingPrice").value)
];


  doc.autoTable({
  startY: y,
  head: [headers2],
  body: [row2],
  theme: 'grid',
  headStyles: {
  fillColor: [208, 171, 128],
  textColor: 0 // 0 = black
}

});

  y = doc.lastAutoTable.finalY + 10;

  // Financial Table
  doc.text(t.finance, 15, y); y += 8;
  const headers3 = t.headers3;


    const row3 = [
    formatPlainNumber(window._calculatedValues.total),
    formatPlainNumber(window._calculatedValues.initial),
    formatPlainNumber(window._calculatedValues.remaining)
    ];




  doc.autoTable({
  startY: y,
  head: [headers3],
  body: [row3],
  theme: 'grid',
  headStyles: {
  fillColor: [208, 171, 128],
  textColor: 0 // 0 = black
}

});

        // Footer
    doc.setFontSize(8);
    doc.setTextColor(90, 90, 90);
    doc.text("GROUPE AAFER IMMOBILIER - ROUTE DE MALABATA, TANGIER OFFSHORE PLAZA, BORJ AL ANDALOUS I", 105, 280, { align: "center" });
    doc.text("+212 539 944 323 | +212 660 370 388", 105, 285, { align: "center" });
    doc.text("Lun-Ven 09h-17h Â· Sam 09h-13h", 105, 290, { align: "center" });


  doc.save("fiche-client.pdf");
}


  </script>
</body>
</html>
